{% extends "admin/base.html" %}

{% block title %}Movies Management{% endblock %}

{% block page_title %}Movies Management{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMovieModal">
    <i class="fas fa-plus"></i> New Movie
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="mb-3">
            <form id="search-form" class="d-flex">
                <input type="text" id="search-input" class="form-control me-2" placeholder="Search movies...">
                <button class="btn btn-outline-primary" type="submit">Search</button>
            </form>
        </div>
        
        {% if movies %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Poster</th>
                            <th>Title</th>
                            <th>Categories</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movie in movies %}
                        <tr class="movie-item">
                            <td>
                                <img src="{{ movie.poster_url }}" alt="{{ movie.title }}" class="img-thumbnail" style="height: 80px;">
                            </td>
                            <td>
                                <h5>{{ movie.title }}</h5>
                                <small class="text-muted">{{ movie.description|truncatechars:100 }}</small>
                            </td>
                            <td>
                                {% for category in movie.categories %}
                                    <span class="badge bg-primary me-1">{{ category.name }}</span>
                                {% empty %}
                                    <span class="text-muted">Not in any category</span>
                                {% endfor %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-secondary edit-movie" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editMovieModal"
                                        data-id="{{ movie.id }}"
                                        data-title="{{ movie.title }}"
                                        data-description="{{ movie.description }}"
                                        data-poster-url="{{ movie.poster_url }}"
                                        data-background-url="{{ movie.background_image_url }}"
                                        data-link="{{ movie.link }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteMovieModal"
                                        data-id="{{ movie.id }}"
                                        data-title="{{ movie.title }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                No movies created yet. Create your first movie to get started.
            </div>
        {% endif %}
    </div>
</div>

<!-- Create Movie Modal -->
<div class="modal fade" id="createMovieModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'create-movie' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Create New Movie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="movieTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="movieTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="movieDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="movieDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="moviePosterUrl" class="form-label">Poster URL</label>
                        <input type="url" class="form-control" id="moviePosterUrl" name="poster_url" required>
                        <small class="form-text text-muted">URL to the movie poster image (e.g., from TMDB)</small>
                    </div>
                    <div class="mb-3">
                        <label for="movieBackgroundUrl" class="form-label">Background Image URL</label>
                        <input type="url" class="form-control" id="movieBackgroundUrl" name="background_image_url" required>
                        <small class="form-text text-muted">URL to the movie background image (e.g., from TMDB)</small>
                    </div>
                    <div class="mb-3">
                        <label for="movieLink" class="form-label">Link</label>
                        <input type="text" class="form-control" id="movieLink" name="link" value="#" required>
                        <small class="form-text text-muted">Link for "Watch Now" button</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Movie Modal -->
<div class="modal fade" id="editMovieModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editMovieForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Edit Movie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editMovieTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editMovieTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMovieDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editMovieDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editMoviePosterUrl" class="form-label">Poster URL</label>
                        <input type="url" class="form-control" id="editMoviePosterUrl" name="poster_url" required>
                        <div class="mt-2">
                            <img id="posterPreview" src="" alt="Poster Preview" style="max-height: 150px;" class="img-thumbnail">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMovieBackgroundUrl" class="form-label">Background Image URL</label>
                        <input type="url" class="form-control" id="editMovieBackgroundUrl" name="background_image_url" required>
                        <div class="mt-2">
                            <img id="backgroundPreview" src="" alt="Background Preview" style="max-height: 150px;" class="img-thumbnail">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMovieLink" class="form-label">Link</label>
                        <input type="text" class="form-control" id="editMovieLink" name="link" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Movie Modal -->
<div class="modal fade" id="deleteMovieModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteMovieForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Delete Movie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the movie "<span id="deleteMovieTitle"></span>"?</p>
                    <p class="text-danger">This will also remove the movie from all categories and the hero section if it's selected there.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Movie search functionality
        $("#search-form").submit(function(e) {
            e.preventDefault();
            const searchTerm = $("#search-input").val().toLowerCase();
            
            $(".movie-item").each(function() {
                const title = $(this).find("h5").text().toLowerCase();
                const description = $(this).find("small").text().toLowerCase();
                
                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
        
        // Edit Movie Modal
        $('.edit-movie').click(function() {
            const movieId = $(this).data('id');
            const title = $(this).data('title');
            const description = $(this).data('description');
            const posterUrl = $(this).data('poster-url');
            const backgroundUrl = $(this).data('background-url');
            const link = $(this).data('link');
            
            $('#editMovieTitle').val(title);
            $('#editMovieDescription').val(description);
            $('#editMoviePosterUrl').val(posterUrl);
            $('#editMovieBackgroundUrl').val(backgroundUrl);
            $('#editMovieLink').val(link);
            
            // Set preview images
            $('#posterPreview').attr('src', posterUrl);
            $('#backgroundPreview').attr('src', backgroundUrl);
            
            $('#editMovieForm').attr('action', `{% url 'edit-movie' 0 %}`.replace('0', movieId));
        });
        
        // Update preview images when URLs change
        $('#editMoviePosterUrl').on('change', function() {
            $('#posterPreview').attr('src', $(this).val());
        });
        
        $('#editMovieBackgroundUrl').on('change', function() {
            $('#backgroundPreview').attr('src', $(this).val());
        });
        
        // Delete Movie Modal
        $('#deleteMovieModal').on('show.bs.modal', function(e) {
            const button = $(e.relatedTarget);
            const movieId = button.data('id');
            const movieTitle = button.data('title');
            
            $('#deleteMovieTitle').text(movieTitle);
            $('#deleteMovieForm').attr('action', `{% url 'delete-movie' 0 %}`.replace('0', movieId));
        });
    });
</script>
{% endblock %} 